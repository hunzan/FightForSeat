<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ“Šé€€æ¶ä½å¥§ä¿—è¾£ï¼ˆÃ€u-sut-Ã¡ï¼‰Fight For Seat</title>
        <!-- âœ… Google AdSense ç¶²ç«™é©—è­‰ -->
  <meta name="google-site-verification" content="AbCdEfGhIjKlMnOpQrStUvWxYz1234567890" />

    <!-- âœ… AdSense å…¨åŸŸè¼‰å…¥ï¼šåªéœ€ä¸€æ¬¡ -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4184107654032285"
          crossorigin="anonymous"></script>
  <meta name="theme-color" content="#0b0d10" />
<style>
  :root{
    --bg:#0b0d10; --fg:#e9eef5; --muted:#b6c0cf; --accent:#ffd452; --danger:#ff5d6e; --glass:rgba(255,255,255,.06);
    --card-w: 150px;   /* ç©å®¶ & å°æ€ªå¡ç‰‡å¯¬ */
    --card-h: 240px;   /* ç©å®¶ & å°æ€ªå¡ç‰‡é«˜ */
    --boss-w: 210px;   /* Boss å¯¬ */
    --boss-h: 336px;   /* Boss é«˜ */
  }
  *{box-sizing:border-box}

  /* === NEW: è®“æ•´é æ”¹æˆå‚ç›´ flexï¼Œä¸»å…§å®¹æ’é–‹ï¼Œfooter è²¼åº• === */
  html,body{height:100%}
  body{
    margin:0;
    background:#0b0d10;
    color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Helvetica,Arial,sans-serif;
    display:flex;               /* NEW */
    flex-direction:column;      /* NEW */
    min-height:100%;            /* NEWï¼šä¿éšª */
  }

  header{text-align:center;padding:1rem}
  h1{margin:0;font-size:1.8rem}

  /* ====== å…±ç”¨å¡ç‰‡ / ç‰ˆé¢ ====== */
  .container{
    max-width:980px;
    margin:0 auto;
    padding:0 12px 24px;
    flex:1 0 auto;             /* NEWï¼šæŠŠå®¹å™¨ç•¶ä¸»å…§å®¹ï¼Œæ’é–‹ä¸­é–“ç©ºé–“ */
  }
  .card{background:var(--glass);border:1px solid rgba(255,255,255,.14);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .hint{color:var(--muted)}

  /* ====== è¨­å®šï¼ˆé¸è§’ï¼‰ ====== */
  #setup{padding:16px;display:grid;gap:16px}
  .grid-2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .roster{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .choice{position:relative;border-radius:14px;overflow:hidden;border:2px solid transparent}
  .choice input{position:absolute;inset:0;opacity:0}
  .face{aspect-ratio:3/4;background:linear-gradient(180deg,#30384a,#202634);display:grid;place-items:center}
  .face img{width:100%;height:100%;object-fit:cover}
  .label{padding:8px 10px;background:#111;display:flex;gap:8px;align-items:center}
  .choice:has(input:focus-visible){outline:3px solid var(--accent);outline-offset:3px}
  .choice:has(input:checked){border-color:var(--accent);box-shadow:0 0 0 4px rgba(255,212,82,.15)}
  input[type="text"],select{width:100%;padding:.7rem .8rem;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);color:var(--fg)}
  .actions{display:flex;gap:12px;justify-content:flex-end;align-items:center}
  button{appearance:none;border:0;border-radius:14px;padding:.85rem 1.1rem;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--accent);color:#111}
  .btn-ghost{background:transparent;color:var(--fg);border:1px solid rgba(255,255,255,.2)}

  /* ====== éŠæˆ²èˆå° ====== */
  #hud{display:flex;justify-content:space-between;align-items:center;padding:.5rem 1rem;background:rgba(255,255,255,.08);border-radius:12px 12px 0 0}
  #hud span{margin-right:1rem}
  #stage{
    user-select:none;
    -webkit-user-select:none;
    outline:0;
    position:relative;
    height:64vh;min-height:380px;
    overflow:hidden;
    border:2px solid #555;border-radius:0 0 12px 12px;
    background: url("assets/bg/mrt_carriage.webp") center center / cover no-repeat;
    margin-bottom: 0;            /* NEWï¼šé¿å…èˆå°åº•ä¸‹å†é•·å‡ºå¤šé¤˜ç©ºç™½ */
  }
  .player,.enemy{
    position:absolute;
    bottom:18px;
    width:var(--card-w);
    height:var(--card-h);
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    transition:transform .25s ease, opacity .25s ease;
  }
  .enemy.boss{
    width:var(--boss-w);
    height:var(--boss-h);
    filter:drop-shadow(0 6px 12px rgba(255,0,0,.35));
  }
  .player { left: calc(50% - 40px); transform: translateX(-50%); }

  @keyframes kick-pop {
    0%   { transform: translateX(-50%) scale(0.6); opacity: 0; }
    30%  { transform: translateX(-50%) scale(1.2); opacity: 1; text-shadow: 0 0 12px rgba(255,212,82,.8); }
    60%  { transform: translateX(-50%) scale(1);   opacity: 1; text-shadow: 0 0 20px rgba(255,212,82,.6); }
    100% { transform: translateX(-50%) scale(1);   opacity: 0; text-shadow: none; }
  }
  .player.kicking::after{
    content:"é£›è¸¢ğŸ’¥";
    position:absolute;
    top:-50px;
    left:50%;
    transform:translateX(-50%);
    background:var(--accent);
    color:#111;
    padding:6px 14px;
    border-radius:14px;
    font-weight:1000;
    font-size:1.2rem;
    white-space:nowrap;
    animation: kick-pop 2.0s ease forwards;
  }
  .enemy.ko{transform:translateY(-150px) rotate(45deg);opacity:0}

  .overlay{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.7);color:#fff}
  .overlay.show{display:grid}
  .panel{background:#111;padding:1rem 1.5rem;border-radius:12px;text-align:center}

  /* å€’æ•¸æç¤º */
  #countdown{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45)}
  #countdown.show{display:grid}
  #countdown b{font-size:56px}

  /* é£›è¸¢å‹•ç•« */
  @keyframes kick-jump {
    0%   { transform: translateX(-50%) translateY(0) rotate(0); }
    25%  { transform: translateX(calc(-50% + 10px)) translateY(-48px) rotate(-18deg); }
    45%  { transform: translateX(calc(-50% + 16px)) translateY(-62px) rotate(-22deg); }
    70%  { transform: translateX(calc(-50% + 8px)) translateY(-28px) rotate(-8deg); }
    100% { transform: translateX(-50%) translateY(0) rotate(0); }
  }
  .player.kicking { animation: kick-jump 0.45s ease; transform-origin: 60% 80%; }

  /* è¸¢æ“Šåˆ¤å®šæ¡† */
  .kickbox {
    position:absolute; bottom:18px; height:84px; width:68px;
    background: transparent; border: 1px dashed transparent;
    pointer-events:none; display:none; border-radius:8px;
  }
  .kickbox.show { display:block; }

  @keyframes hit-flash { 0%{ box-shadow: inset 0 0 0 rgba(255,0,0,0)}
    40%{ box-shadow: inset 0 0 40px rgba(255,0,0,.8)}
    70%{ box-shadow: inset 0 0 25px rgba(255,0,0,.6)}
    100%{ box-shadow:none}}
  .player.hit { animation: hit-flash 0.5s ease; }

  /* ç©å®¶è¢«æ’å‹•ç•« */
  @keyframes player-knock-fall-left {
    0%   { transform: translateX(-50%) translateY(0) rotate(0deg) scale(1,1); }
    20%  { transform: translateX(-50%) translateY(30px) rotate(-90deg) scale(1.05,.85);}
    45%  { transform: translateX(-50%) translateY(-20px) rotate(-70deg) scale(.95,1.05);}
    65%  { transform: translateX(-50%) translateY(15px) rotate(-30deg) scale(1.02,.9);}
    80%  { transform: translateX(-50%) translateY(-10px) rotate(-10deg) scale(.98,1.02);}
    100% { transform: translateX(-50%) translateY(0) rotate(0deg) scale(1,1);}
  }
  .player.hit-knock { animation: player-knock-fall-left 1.1s cubic-bezier(.25,.9,.35,1.3); will-change: transform;}

  @keyframes walk-sway { 0%{transform:translate(0,0) rotate(0)}
    25%{transform:translate(-3px,-2px) rotate(-2deg)}
    50%{transform:translate(0,0) rotate(0)}
    75%{transform:translate(3px,2px) rotate(2deg)}
    100%{transform:translate(0,0) rotate(0)}}
  .enemy { animation: walk-sway 0.6s infinite ease-in-out; }

  .enemy.boss { animation: walk-sway-boss 0.7s infinite ease-in-out; }
  @keyframes walk-sway-boss { 0%{transform:translate(0,0) rotate(0)}
    25%{transform:translate(-6px,-4px) rotate(-4deg)}
    50%{transform:translate(0,0) rotate(0)}
    75%{transform:translate(6px,4px) rotate(4deg)}
    100%{transform:translate(0,0) rotate(0)}}

  /* å°æ€ªè¢«è¸¢ä¸­ â†’ é£›èµ°æ—‹è½‰ */
  .enemy.ko { transform-origin:center; animation: knockback-spin 2s cubic-bezier(.25,1.4,.45,1) forwards; will-change: transform; }
  .enemy.boss.ko { animation: boss-knockback-spin 2.5s cubic-bezier(.25,1.4,.45,1) forwards; }
  @keyframes knockback-spin {
    0%{ transform: translate(0,0) rotate(0) scale(1); opacity:1;}
    25%{ transform: translate(80px,-50px) rotate(180deg) scale(1.05);}
    50%{ transform: translate(200px,-140px) rotate(360deg) scale(0.98);}
    75%{ transform: translate(320px,-200px) rotate(540deg) scale(0.96);}
    100%{transform: translate(480px,-260px) rotate(720deg) scale(0.95); opacity:0;}
  }
  @keyframes boss-knockback-spin {
    0%{ transform: translate(0,0) rotate(0) scale(1); opacity:1;}
    25%{ transform: translate(100px,-70px) rotate(270deg) scale(1.05);}
    50%{ transform: translate(240px,-160px) rotate(540deg) scale(0.98);}
    75%{ transform: translate(380px,-240px) rotate(810deg) scale(0.96);}
    100%{transform: translate(600px,-320px) rotate(1080deg) scale(0.94); opacity:0;}
  }

  .sr-only{
    position:absolute !important;
    width:1px;height:1px;overflow:hidden;
    clip:rect(1px,1px,1px,1px);white-space:nowrap;
    border:0;padding:0;margin:-1px;
  }
  @keyframes boss-flinch {
    0% { transform: translate(0,0) rotate(0); }
    30% { transform: translate(8px,-4px) rotate(3deg); }
    100% { transform: translate(0,0) rotate(0); }
  }
  .enemy.boss.flinch { animation: boss-flinch .18s ease; }

  /* æ•´é å‚ç›´æ’åˆ—ï¼Œä¸»å…§å®¹æ’é–‹ï¼Œä¸­é–“ä¸ç•™è«åç©ºç™½ */
  html, body { height: 100%; }
  body {
    margin: 0;
    display: flex;
    flex-direction: column;
    min-height: 100%;
  }

  /* ä½ çš„ä¸»å®¹å™¨ï¼ˆmain.containerï¼‰ç•¶ä¸»å…§å®¹ï¼Œæ’é–‹ä¸­é–“ç©ºé–“ */
  .container { flex: 1 0 auto; }

  /* èˆå°åº•ä¸‹ä¸è¦å†é•·é¡å¤–ç©ºç™½ */
  #stage { margin-bottom: 0; }

  /* å€å¡Šé–“è·ç”¨å°é‡æ§åˆ¶å³å¯ */
  #gameWrap { margin-top: 16px; }
  .ad-container { margin-top: 12px; }

  /* footer é€ å‹ï¼ˆ12pt/ç½®ä¸­/æ·¡é‚Šï¼‰ */
  .footer {
    width: 100%;
    text-align: center;
    color: #777;
    font-size: 12pt;
    line-height: 1.6;
    margin-top: 12px;         /* æƒ³æ›´è²¼å°±æ”¹æˆ 8px æˆ– 0 */
    padding: 16px 0;
    border-top: 1px solid rgba(0,0,0,0.1);
    background: rgba(255,255,255,0.05);
    flex-shrink: 0;           /* ä¸è¦è¢«æ’é–‹ */
  }
  .footer p { margin: 0; }
  .ad-footer { margin-top: .5rem; }
</style>
</head>
<body>
  <header>
    <h1>æ“Šé€€æ¶ä½å¥§ä¿—è¾£ï¼ˆÃ€u-sut-Ã¡ï¼‰Fight For Seat <small style="font-weight:400;color:var(--muted)">é¸è§’ ğŸ‘‰ å°æ±º</small></h1>
    <p class="hint">æ“ä½œæ–¹å¼ï¼šæŒ‰ç©ºç™½éµï¼Enterï¼<b>Z</b>ã€Œé£›è¸¢ã€ğŸ’¥ã€€ç”¨å·¦å³éµ â¬…ï¸â¡ï¸ ç§»å‹•</p>
  </header>
  <!-- çµ¦è¢å¹•é–±è®€å™¨çš„æ•´é å°è¦½èªªæ˜ -->
  <p id="sr-page-intro" class="sr-only">
    é€™æ˜¯ä¸€æ¬¾å¡ç‰‡å°æ±ºéŠæˆ²ã€‚å…ˆåœ¨æœ¬é é¸æ“‡è§’è‰²èˆ‡ä»»å‹™ç›®æ¨™ï¼Œ
    æŒ‰ã€Œé–‹å§‹éŠæˆ²ã€é€²å…¥å°æ±ºã€‚é€²å…¥éŠæˆ²å¾Œï¼Œä½¿ç”¨å·¦å³æ–¹å‘éµç§»å‹•ä½ç½®ï¼Œ
    NVDA ä½¿ç”¨è€…æŒ‰è‹±æ–‡ Z éµæˆ– Enter éµä½¿å‡ºé£›è¸¢ï¼Œ
    ç›®æ¨™æ˜¯æŠŠä¸€å®šæ•¸é‡çš„é˜¿å–ªè¸¢é£›ï¼Œæœ€å¾Œæœƒå‡ºç¾ Boss ç´šé˜¿å–ªï¼Œéœ€è¦é€£ç’°è¸¢æ‰èƒ½æ“Šé€€ã€‚
  </p>

  <main class="container">
    <!-- ====== é¸è§’å€ ====== -->
    <section id="setup" class="card" aria-label="é¸è§’èˆ‡è¨­å®š"
         aria-labelledby="choose-title"
         aria-describedby="sr-page-intro roster-help">
ã€€ã€€<h2 id="choose-title" class="sr-only">é¸è§’èˆ‡ä»»å‹™è¨­å®š</h2>
      <p id="roster-help" class="sr-only">
        å…ˆè¼¸å…¥æš±ç¨±ä¸¦è¨­å®šä»»å‹™ç›®æ¨™ KO æ•¸ï¼Œå†åˆ°å–®é¸æ¸…å–®ï¼Œå…±æœ‰ä¸‰å€‹è§’è‰²å¯é¸æ“‡ï¼Œè«‹ç§»å‹•å·¦å³éµæ¡†é¸ä½ è¦çš„è§’è‰²å¡ï¼Œå†æŒ‰ Tab éµåˆ°ã€Œé–‹å§‹éŠæˆ²ã€æŒ‰éˆ•ã€‚
      </p>
      <div class="grid-2">
        <div>
          <label for="nickname">ç©å®¶æš±ç¨±</label>
          <input id="nickname" type="text" placeholder="è¼¸å…¥æ‚¨çš„æš±ç¨±ï¼ˆå¯ç•™ç™½ï¼‰" maxlength="18" />
        </div>
        <div>
          <label for="goal">ä»»å‹™ç›®æ¨™ï¼ˆKO æ•¸ï¼‰</label>
          <select id="goal">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="15">15</option>
          </select>
        </div>
      </div>

      <p class="hint">è«‹é¸æ“‡æ‚¨çš„è§’è‰²å¡ï¼ˆæ¯å€‹äººéƒ½æ˜¯ No.1ï¼‰</p>
      <div class="roster" role="radiogroup" aria-label="é¸è§’æ¸…å–®" aria-describedby="roster-help">
        <label class="choice" role="listitem">
          <input type="radio" name="avatar" value="male-longdress" checked aria-label="é•·é«®ç¶é¦¬å°¾é•·é»‘è£™ç¾ç”·å­ï¼Œæè‘—ç™½è‰²ç²¾å“ç´™è¢‹ï¼Œå¡ç‰‡æ¨™èªï¼šè‹±é›„æœ‰æ™‚æ˜¯ç©¿é•·è£™ã€‚å°çŸ­å¥ï¼šç‰©ç†æ²»ç™‚è¶…æœ‰æ•ˆï¼" />
          <div class="face"><img alt="é•·é«®ç¶é¦¬å°¾é•·é»‘è£™ç¾ç”·å­" src="assets/players/male-longdress.webp" onerror="this.remove()"></div>
          <div class="label">ğŸ˜†<b>ç‰©ç†æ²»ç™‚è¶…æœ‰æ•ˆï¼</b></div>
        </label>
        <label class="choice" role="listitem">
          <input type="radio" name="avatar" value="pregnant" aria-label="ä¸­é•·é«®æº«æŸ”å­•å©¦ï¼Œå¡ç‰‡æ¨™èªï¼šç‚ºå®ˆè­·å¯¶å¯¶è€Œæˆ°ã€‚å°çŸ­å¥ï¼šæ­£æ‰€è¬‚ï¼Œç‚ºæ¯å‰‡å¼·ã€‚" />
          <div class="face"><img alt="ä¸­é•·é«®æº«æŸ”å­•å©¦" src="assets/players/pregnant.webp" onerror="this.remove()"></div>
          <div class="label">â¤ï¸<b>æ­£æ‰€è¬‚ï¼šç‚ºæ¯å‰‡å¼·ï¼</b></div>
        </label>
        <label class="choice" role="listitem">
          <input type="radio" name="avatar" value="hs-girl" aria-label="æ–‡é’å¥³é«˜ä¸­ç”Ÿï¼Œæˆ´çœ¼é¡ï¼Œç¶å…©æ ¹è¾®å­ï¼Œå¡ç‰‡æ¨™èªï¼šé«”è‚²èª²å¾ˆé‡è¦å”·ã€‚å°çŸ­å¥ï¼šåˆ¥ä»¥ç‚ºå¥³ç”Ÿå¥½æ¬ºè² ã€‚" />
          <div class="face"><img alt="æ–‡é’å¥³é«˜ä¸­ç”Ÿ" src="assets/players/hs-girl.webp" onerror="this.remove()"></div>
          <div class="label">ğŸŒ¸<b>åˆ¥ä»¥ç‚ºå¥³ç”Ÿå¥½æ¬ºè² ï¼</b></div>
        </label>
      </div>

      <div class="actions">
        <button id="btnStart" class="btn-primary">é–‹å§‹éŠæˆ²</button>
      </div>
    </section>

    <!-- ====== éŠæˆ²å€ ====== -->
    <section id="gameWrap" class="card" aria-label="æ·é‹å°æ±ºå€" style="margin-top:16px;display:none">
      <div id="hud" aria-live="polite" aria-atomic="true">
        <div>
          <span id="hudName">æš±ç¨±ï¼šâ€”</span>
          <span>ç›®æ¨™ï¼š<b id="hudGoal">10</b></span>
          <span>ç”Ÿå‘½ï¼š<b id="hudLives">3</b></span>
        </div>
        <div>
          <span>å·² KOï¼š<b id="hudScore">0</b></span>
          <span>ç‹€æ…‹ï¼š<b id="hudState">å€’æ•¸</b></span>
          <button id="btnHome" class="btn-ghost" style="margin-left:12px">å›é¸è§’</button>
        </div>
      </div>
      <button id="focusGame" class="sr-only">
        å•Ÿç”¨éŠæˆ²æ§åˆ¶ï¼ˆNVDA ä½¿ç”¨è€…æŒ‰ Enter æˆ–è‹±æ–‡ Z ç©ºç™½éµåŸ·è¡Œé£›è¸¢ï¼‰
      </button>

      <div
        id="stage"
        tabindex="0"
        role="application"
        contenteditable="true"
        spellcheck="false"
        aria-label="å¡ç‰‡å°æ±ºèˆå°ã€‚æŒ‰è‹±æ–‡ Z æˆ– Enter ä½¿å‡ºé£›è¸¢ï¼›å·¦å³æ–¹å‘éµç§»å‹•ã€‚"
        aria-keyshortcuts="Z Space Enter">
        <div id="player" class="player" aria-label="ç©å®¶è§’è‰²"></div>
        <div id="kickbox" class="kickbox" aria-hidden="true"></div>
        <div id="countdown"><b>3</b></div>
      </div>

      <div id="over" class="overlay" aria-hidden="true">
        <div class="panel"
             id="dialogPanel"
             role="dialog"
             aria-modal="true"
             aria-labelledby="overTitle"
             aria-describedby="overMsg"
             tabindex="-1">
          <h2 id="overTitle">çµç®—</h2>
          <p id="overMsg">â€”</p>
          <div style="display:flex;gap:10px;justify-content:center">
            <button id="btnReplay" class="btn-primary">å†æˆ°ä¸€å ´</button>
            <button id="btnHome2" class="btn-ghost">å›é¸è§’</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Live regions -->
    <div id="sr-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    <div id="sr-live-assertive" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
                <!-- âœ… å»£å‘Šå€å¡Š 1ï¼šæ”¾åœ¨çµæœä¸‹æ–¹ -->
    <div class="ad-container">
      <ins class="adsbygoogle"
           style="display:block; text-align:center;"
           data-ad-client="ca-pub-4184107654032285"
           data-ad-slot="9988828914"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </main>

<script>
(function(){
  const $ = (s,el=document)=>el.querySelector(s); const $$ = (s,el=document)=>[...el.querySelectorAll(s)];
  const START_GRACE_MS = 900; // é–‹å ´ä¿è­·

  // ====== DOM ======
  const setup = $('#setup');
  const btnStart = $('#btnStart');
  const nickEl = $('#nickname');
  const goalSel = $('#goal');

  const gameWrap = $('#gameWrap');
  const stage = $('#stage');
  const player = $('#player');
  const hudName = $('#hudName');
  const hudGoal = $('#hudGoal');
  const hudScore = $('#hudScore');
  const hudState = $('#hudState');
  const btnHome = $('#btnHome');
  const btnHome2 = $('#btnHome2');
  const btnReplay = $('#btnReplay');
  const overlay = $('#over');
  const overTitle = $('#overTitle');
  const overMsg = $('#overMsg');
  const countdown = $('#countdown');
  const BOSS_HITS = 3;
  const kickbox = $('#kickbox');
  const hudLives = $('#hudLives');
  const srLive = document.getElementById('sr-live');
  const srLiveAssert = document.getElementById('sr-live-assertive');
  const dialogPanel = document.getElementById('dialogPanel');
  let __preDialogFocused = null;

  // ===== èªéŸ³å·¥å…· =====
  // èªéŸ³å†—é•·åº¦ï¼ˆ'brief' = å·¦å³éµæœƒçŸ­å”¸ï¼›'none' = å®Œå…¨ä¸å”¸ï¼‰
  let SR_VERBOSITY = 'brief';

  function speakPolite(msg){
    srLive.textContent = '';
    setTimeout(()=>{ srLive.textContent = msg; }, 30);
  }
  function speakAssertive(msg){
    srLiveAssert.textContent = '';
    setTimeout(()=>{ srLiveAssert.textContent = msg; }, 30);
  }

  function speak(msg){ // å‘å¾Œç›¸å®¹
    speakPolite(msg);
  }

  // è®“ã€Œå•Ÿç”¨æ§åˆ¶ã€æŒ‰éˆ•æŠŠç„¦é»é€é€²èˆå°
  const btnFocus = document.getElementById('focusGame');
  if (btnFocus) {
    btnFocus.addEventListener('click', () => { focusStageSoon(); });
  }

  // æ¯æ¬¡é–‹å§‹æˆ–å›åˆ°éŠæˆ²ï¼Œéƒ½ä¸»å‹•æŠŠç„¦é»æ”¾é€²èˆå°
  function focusStageSoon(){
    setTimeout(() => { stage.focus(); }, 100);
  }

  // ===== èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶ =====
  let bgm = null, bgmUnlocked = false;
  function createBgm() { const a = new Audio("assets/sounds/war.ogg"); a.loop = true; a.volume = 0.7; return a; }
  function playBgm() { if (!bgm) bgm = createBgm(); if (bgmUnlocked) bgm.play().catch(()=>{}); }
  function stopBgm() { if (bgm) { bgm.pause(); bgm.currentTime = 0; } }
  function ensureBgm() {
    if (!bgm) bgm = createBgm();
    const tryPlay = () => {
      bgm.play().then(() => {
        bgmUnlocked = true;
        window.removeEventListener('pointerdown', tryPlay);
        window.removeEventListener('keydown', tryPlay);
      }).catch(()=>{});
    };
    tryPlay();
    window.addEventListener('pointerdown', tryPlay, { once: true });
    window.addEventListener('keydown', tryPlay, { once: true });
  }
  ensureBgm();

  // ===== é¸è§’éŸ³æ•ˆ =====
  const selectSfx = new Audio("assets/sounds/ui_select.ogg");
  selectSfx.volume = 0.6;
  $$('input[name="avatar"]').forEach(radio=>{
    radio.addEventListener('change', ()=>{
      selectSfx.currentTime = 0; selectSfx.play().catch(()=>{});
      const name = radio.closest('.choice')?.querySelector('.label b')?.textContent || 'è§’è‰²';
      speakPolite(`å·²é¸æ“‡ï¼š${name}`);
    });
  });
  goalSel.addEventListener('change', ()=>{ speakPolite(`ç›®æ¨™è¨­å®šç‚º ${goalSel.value} éš»`); });

  // ===== è²éŸ³ï¼ˆå°è©ï¼‰ =====
  const VOICES = {
    atk:["asan_atk_01.ogg","asan_atk_02.ogg","asan_atk_03.ogg","asan_atk_04.ogg","asan_atk_05.ogg"],
    spc_boa:["asan_spc_boa_01.ogg","asan_spc_boa_02.ogg","asan_spc_boa_03.ogg"],
    spc_team:["asan_spc_team_01.ogg","asan_spc_team_02.ogg","asan_spc_team_03.ogg"],
    ko:["asan_ko_01.ogg","asan_ko_02.ogg","asan_ko_03.ogg","asan_ko_04.ogg","asan_ko_05.ogg"],
    boss_intro:["asan_boss_intro.ogg"], boss_ko:["asan_boss_ko.ogg"]
  };
  const pick = a=>a[Math.floor(Math.random()*a.length)];
  let lastVoiceAt = 0;
  function playVoice(type){
    const arr = VOICES[type]; if(!arr) return;
    const now = performance.now();
    if (now - lastVoiceAt < 700) return;
    lastVoiceAt = now;
    const a = new Audio('assets/sounds/asan/' + pick(arr)); a.volume = 0.8; a.play().catch(()=>{});
  }
  function makeSfxPlayer(path, vol = 0.8, gap = 80){
    let last = 0;
    return function(){
      const now = performance.now(); if (now - last < gap) return; last = now;
      const a = new Audio(path); a.volume = Math.max(0, Math.min(1, vol)); a.play().catch(()=>{});
    }
  }
  const playKick = makeSfxPlayer("assets/sounds/kick.ogg", 0.75, 80);
  const playHit  = makeSfxPlayer("assets/sounds/hit.ogg",  0.85, 80);
  const playFail = makeSfxPlayer("assets/sounds/fail.ogg", 0.85, 120);
  const playWin = makeSfxPlayer("assets/sounds/win.ogg", 0.9, 300);  // å‹åˆ©ï¼ˆéé—œï¼‰éŸ³æ•ˆ
  const playLose = makeSfxPlayer("assets/sounds/final_fail.ogg",  0.9, 300);

  const __preloadBoss = new Image(); __preloadBoss.src = 'assets/enemy/asan_boss.webp';

  function cssNum(el, prop){ const v = getComputedStyle(el).getPropertyValue(prop); return parseFloat(v) || 0; }
  function cardSize(isBoss){
    const w = cssNum(player, isBoss ? '--boss-w' : '--card-w') || (isBoss ? 116 : player.clientWidth);
    const h = cssNum(player, isBoss ? '--boss-h' : '--card-h') || (isBoss ? 180 : player.clientHeight);
    return { w, h };
  }

  // ===== ç‹€æ…‹ =====
  const S = {
    running:false, score:0, goal:10, kickWindow:false,
    nick:'', avatar:'male-longdress', startTime:0, bossDefeated:false,
    bossSpawned:false, lives:3, active:0, spawnLocked:false, queueBoss:false,
    kickSeq: 0,
    playerIntroPlayed: false
  };

  function getAvatarPath(val){
    const map = {
      'male-longdress':'assets/players/male-longdress.webp',
      'pregnant':'assets/players/pregnant.webp',
      'hs-girl':'assets/players/hs-girl.webp'
    };
    return map[val] || map['male-longdress'];
  }

  // ===== æµç¨‹æ§åˆ¶ =====
  btnStart.addEventListener('click', ()=>{
    playBgm();
    S.avatar = ($('input[name="avatar"]:checked')||{}).value || 'male-longdress';
    S.nick = (nickEl.value||'').trim();
    S.goal = Number(goalSel.value||10);

    hudName.textContent = 'æš±ç¨±ï¼š' + (S.nick || 'â€”');
    hudGoal.textContent = String(S.goal);
    hudScore.textContent = '0';
    hudState.textContent = 'å€’æ•¸';

    setup.style.display='none';
    gameWrap.style.display='block';
    player.style.backgroundImage = `url(${getAvatarPath(S.avatar)})`;

    const gw = stage.clientWidth; const pw = player.clientWidth;
    const initX = gw / 3 - pw / 2; player.style.left = initX + 'px';
    player.classList.remove('kicking');

    focusStageSoon();
    countdown.classList.add('show');
    const cd = countdown.querySelector('b');
    cd.textContent='3';
    setTimeout(()=>{cd.textContent='2';},400);
    setTimeout(()=>{cd.textContent='1';},800);
    setTimeout(()=>{
      countdown.classList.remove('show');
      startGame();
      focusStageSoon();
    },1200);

    speakPolite('é€²å…¥å°æ±ºã€‚æŒ‰ Z æˆ–ç©ºç™½éµæˆ– Enter é£›è¸¢ï¼Œå·¦å³éµç§»å‹•ã€‚è‹¥æœªåæ‡‰ï¼Œè«‹åˆ‡æ›ç‚ºç„¦é»æ¨¡å¼å†è©¦ä¸€æ¬¡ã€‚');
  });

  function backToSetup(){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
    gameWrap.style.display='none';
    setup.style.display='grid';
  }
  btnHome.addEventListener('click', backToSetup);
  btnHome2.addEventListener('click', backToSetup);

  // ====== Dialogï¼šé–‹é—œ/æœ—è®€/é–ç„¦ ======
  function openDialogAndAnnounce(titleText, msgText){
    if (titleText) overTitle.textContent = titleText;
    if (msgText)   overMsg.textContent   = msgText;

    overlay.classList.add('show');
    overlay.removeAttribute('aria-hidden');

    __preDialogFocused = document.activeElement;
    dialogPanel.focus();

    // å‡ºç¾è¦–çª—æ™‚æ‰æ’­çµæŸéŸ³æ•ˆ
    if (/éé—œ/.test(overTitle.textContent)) {
      playWin();
    } else if (/éŠæˆ²çµæŸ/.test(overTitle.textContent)) {
      playLose();
    }

    // ç«‹å³ assertive æœ—è®€
    speakAssertive(`${overTitle.textContent}ã€‚${overMsg.textContent}ã€‚æŒ‰ Tab å¯åœ¨ã€Œå†æˆ°ä¸€å ´ã€èˆ‡ã€Œå›é¸è§’ã€ä¹‹é–“åˆ‡æ›ã€‚`);
  }
  function closeDialogAndRestoreFocus(){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
    if (__preDialogFocused && typeof __preDialogFocused.focus === 'function') {
      __preDialogFocused.focus();
    } else {
      stage.focus();
    }
  }
  dialogPanel.addEventListener('keydown', (e)=>{
    if (e.key === 'Tab'){
      const focusables = [btnReplay, btnHome2].filter(Boolean);
      if (!focusables.length) return;
      const idx = focusables.indexOf(document.activeElement);
      if (e.shiftKey){
        e.preventDefault();
        const prev = idx <= 0 ? focusables.length - 1 : idx - 1;
        focusables[prev].focus();
      } else {
        e.preventDefault();
        const next = idx === focusables.length - 1 ? 0 : idx + 1;
        focusables[next].focus();
      }
    } else if (e.key === 'Escape'){
      e.preventDefault();
      closeDialogAndRestoreFocus();
    }
  });

  btnReplay.addEventListener('click', ()=>{
    closeDialogAndRestoreFocus();
    startGame();
  });

  // ====== éŠæˆ²ä¸»æµç¨‹ ======
  function startGame(){
    clearEnemies();
    S.running = true;
    S.score = 0;
    S.lives = 3;
    S.kickWindow = false;
    S.startTime = performance.now();
    S.bossSpawned = false;
    S.bossDefeated = false;
    S.active = 0;
    S.spawnLocked = false;
    S.queueBoss = false;
    S.playerIntroPlayed = false;
    stage.setAttribute('contenteditable','false'); // é—œæ‰ç·¨è¼¯ï¼Œé¿å…è¼¸å…¥
    hudScore.textContent = '0';
    hudLives.textContent = S.lives;
    hudState.textContent = 'é–‹æ‰“ï¼';
    playPlayerIntroVoiceOnce();  // â˜… å…¥å ´èªéŸ³åªæ’­ä¸€æ¬¡ï¼ˆæ­¤å±€ï¼‰
    focusStageSoon();
    setTimeout(spawnLoop, 1200);
  }
  function endGame(){ S.running=false; }
  function clearEnemies(){ $$('.enemy',stage).forEach(e=>e.remove()); }

  function rect(el){ return el.getBoundingClientRect(); }
  function collide(a,b){ return !(a.right<b.left||a.left>b.right||a.bottom<b.top||a.top>b.bottom); }

  function spawnEnemy(forceBoss=false){
    let isBoss = false;
    if (forceBoss && !S.bossSpawned && S.score >= (S.goal - 1)) {
      isBoss = true;
      S.bossSpawned = true;
    }

    const e = document.createElement('div');
    let hp = isBoss ? BOSS_HITS : 1;   // â† Boss è¦æ‰“ 3 æ¬¡ï¼Œå°æ€ª 1 æ¬¡
    e.className = 'enemy' + (isBoss ? ' boss' : '');
    e.style.backgroundImage = `url(${isBoss ? 'assets/enemy/asan_boss.webp' : 'assets/enemy/asan.webp'})`;
    stage.appendChild(e);
    S.active++;

    let voiceAudio = null;
    let stepAudio  = null;

    if (isBoss) {
      voiceAudio = new Audio('assets/sounds/asan/' + pick(VOICES.boss_intro));
    } else {
      if (Math.random() < 0.15)      voiceAudio = new Audio('assets/sounds/asan/' + pick(VOICES.spc_boa));
      else if (Math.random() < 0.12) voiceAudio = new Audio('assets/sounds/asan/' + pick(VOICES.spc_team));
      else if (Math.random() < 0.20) voiceAudio = new Audio('assets/sounds/asan/' + pick(VOICES.atk));
    }
    if (voiceAudio) voiceAudio.play().catch(()=>{});

    function playEnemyStep(){
      if (stepAudio) { try{ stepAudio.pause(); }catch{} }
      stepAudio = new Audio("assets/sounds/asan/steps/" + pick(isBoss ? BOSS_STEPS : ASAN_STEPS));
      stepAudio.volume = isBoss ? 0.85 : 0.65;
      stepAudio.play().catch(()=>{});
    }

    const base  = isBoss ? 120 : 140;
    let speed   = base + Math.random()*25 + (S.score * 2);
    speed = Math.min(speed, 260);

    const { w: enemyW } = cardSize(isBoss);
    const off = Math.round(enemyW * 2.1);
    let pos = -off;
    e.style.right = pos + 'px';

    let removed = false;
    let dead    = false;

    function cleanup(){
      if (removed) return;
      removed = true;
      try { if (voiceAudio) voiceAudio.pause(); } catch {}
      try { if (stepAudio)  stepAudio.pause();  } catch {}
      voiceAudio = null; stepAudio  = null;
      if (e.parentNode) e.remove();
      S.active = Math.max(0, S.active - 1);
    }

    let lastTs = null;
    let travel = 0;

  function step(ts){
    if (!S.running || removed) return;

    if (lastTs == null) { lastTs = ts; requestAnimationFrame(step); return; }
    const dt = (ts - lastTs) / 1000; lastTs = ts;

    pos += speed * dt;
    e.style.right = pos + 'px';

    travel += speed * dt;
    if (travel >= (isBoss ? 180 : 120)) { playEnemyStep(); travel = 0; }

    const pr = rect(player), er = rect(e);
    const now = performance.now();
    const underGrace = (now - S.startTime) < START_GRACE_MS;
    const kr = kickbox.getBoundingClientRect();

    // === 1) å…ˆè™•ç†ã€Œè¸¢æ“Šå‘½ä¸­ã€ï¼ˆç¶­æŒä½ çš„ kickSeq é˜²é€£åˆ¤ï¼‰===
    if (S.kickWindow && !dead && collide(kr, er)) {

      // â€”â€” åŒä¸€è…³åªåˆ¤ä¸€æ¬¡ â€”â€” //
      if (e.dataset.lastKick === String(S.kickSeq)) {
        requestAnimationFrame(step);
        return;
      }
      e.dataset.lastKick = String(S.kickSeq);

      // å‘½ä¸­éŸ³æ•ˆèˆ‡èˆå°é–ƒå…‰
      playHit();
      stage.classList.add('hit-flash');
      setTimeout(()=> stage.classList.remove('hit-flash'), 250);

      if (isBoss) {
        // â€”â€” Boss æ‰£è¡€ï¼Œä¸ç«‹å³æ­»äº¡ â€”â€” //
        hp = Math.max(0, hp - 1);
        const done = BOSS_HITS - hp; // å·²æ“Šä¸­æ¬¡æ•¸
        hudState.textContent = `Boss å—å‰µï¼ˆ${done}/${BOSS_HITS}ï¼‰`;
        speakPolite(`å‘½ä¸­ Bossï¼Œå·²æ“Šä¸­ ${done} æ¬¡ï¼Œé‚„éœ€ ${hp} æ¬¡`);

        if (hp <= 0) {
          // çœŸæ­£æ“Šå€’ Boss
          dead = true;
          try { if (voiceAudio) voiceAudio.pause(); } catch {}
          try { if (stepAudio)  stepAudio.pause();  } catch {}

          e.classList.add('ko');
          e.addEventListener('animationend', cleanup, { once: true });

          S.bossDefeated = true;                 // â† æ¨™è¨˜ Boss å·²è¢«æ‰“å€’
          S.score += 1;                          // åªæœ‰å€’ä¸‹æ™‚æ‰+1
          hudScore.textContent = String(S.score);
          playVoice('boss_ko');

          // åˆ¤æ–·æ˜¯å¦éé—œ
          if (S.score >= S.goal) {
            // å»¶é² 3 ç§’å†å‡ºç¾ç ´é—œç•«é¢èˆ‡éŸ³æ•ˆ
            setTimeout(() => {
              openDialogAndAnnounce(
                'éé—œ',
                `ä½ æˆåŠŸæ“Šé€€ ${S.goal} éš»å¥§ä¿—è¾£ï¼ˆå« Boss ç´šåˆ¥ï¼‰ï¼`
              );
              endGame();
            }, 3000); // â† 3000 æ¯«ç§’ = 3 ç§’
            return;
          }
        } else {
          // â† Boss æ‰£åˆ°é‚„æ²’æ­»ï¼Œåšå€‹å¾®æ™ƒ
          e.classList.add('flinch');
          setTimeout(()=> e.classList.remove('flinch'), 180);
          // Boss ä¸ç§»é™¤ã€ä¸åŠ åˆ†ï¼Œç¹¼çºŒå¾€å‰èµ°
        }

      } else {
        // â€”â€” å°æ€ªï¼šä¸€æ“Šå€’ â€”â€” //
        dead = true;

        try { if (voiceAudio) voiceAudio.pause(); } catch {}
        try { if (stepAudio)  stepAudio.pause();  } catch {}

        e.classList.add('ko');
        e.addEventListener('animationend', cleanup, { once: true });

        S.score += 1;
        hudScore.textContent = String(S.score);
        hudState.textContent = 'è¸¢ä¸­ï¼';
        playVoice('ko');

        // æ¥ Boss æ™‚æ©Ÿ
        if (!S.bossSpawned && S.score === (S.goal - 1)) {
          S.spawnLocked = true;
          S.queueBoss   = true;
          setTimeout(()=>{ S.spawnLocked = false; }, 600);
        }
      }
    }

    // === 2) ğŸ”¹æ–°å¢ï¼šè¢«æ’åˆ¤å®šï¼ˆåªæœ‰ã€Œä¸åœ¨è¸¢æ“Šçª—ã€æ™‚æ‰æœƒè¢«æ’ï¼‰===
      if (!S.kickWindow && !dead && collide(pr, er) && !underGrace) {
        // ç©å®¶å—æ“Šå‹•ç•«/æ‰£å‘½ï¼ˆåŸæ¨£ï¼‰
        hudState.textContent = 'è¢«æ’';
        playFail();
        speakAssertive('è¢«æ’å€’');
        player.classList.remove('kicking','walking','hit-anim');
        player.classList.add('hit-knock');
        setTimeout(()=> player.classList.remove('hit-knock'), 1100);

        if (S.lives != null) {
          S.lives--;
          if (hudLives) hudLives.textContent = S.lives;
        }

        if (isBoss) {
          // Boss ä¸è¦è¢«ç§»é™¤ï¼åªåœæ‰è²éŸ³ï¼Œä¸¦æŠŠä½ç½®ç¨å¾®ã€Œæ¨å›å»ã€
          try { if (voiceAudio) voiceAudio.pause(); } catch {}
          try { if (stepAudio)  stepAudio.pause();  } catch {}

          // æŠŠ Boss æ¨å›å³é‚Šä¸€é»ï¼Œé¿å…ç«‹åˆ»äºŒæ¬¡æ’åˆ°
          pos = Math.max(-20, pos - 60);      // å¯ä¾æ‰‹æ„Ÿèª¿æ•´ 60
          e.style.right = pos + 'px';

          // çµ¦ç©å®¶çŸ­æš«ä¿è­·
          S.startTime = performance.now();

          // é‡æ–°é–‹å§‹è…³æ­¥éŸ³ï¼ˆå¯é¸ï¼‰
          stepAudio = null;
        } else {
          // å°æ€ªç…§èˆŠï¼šè¢«æ’å°±æ¶ˆå¤±
          try { if (voiceAudio) voiceAudio.pause(); } catch {}
          try { if (stepAudio)  stepAudio.pause();  } catch {}
          cleanup();
        }

        // ç”Ÿå‘½æ­¸é›¶è™•ç†
        if (S.lives != null && S.lives <= 0) {
          endGame();
          setTimeout(() => {
            openDialogAndAnnounce(
              'éŠæˆ²çµæŸ',
              isBoss ? 'Boss é˜¿æ¡‘æŠŠä½ æ’é£›å•¦ï¼' : 'é˜¿æ¡‘æ’ç¿»ä½ äº†ï¼'
            );
          }, 3000);
          return;
        } else if (S.lives == null) {
          endGame();
          setTimeout(() => {
            openDialogAndAnnounce(
              'éŠæˆ²çµæŸ',
              isBoss ? 'Boss é˜¿æ¡‘æŠŠä½ æ’é£›å•¦ï¼' : 'é˜¿æ¡‘æ’ç¿»ä½ äº†ï¼'
            );
          }, 3000);
          return;
        }
      }

      // é›¢å ´/çºŒè·‘
      if (pos > stage.clientWidth) {
        cleanup();
      } else {
        requestAnimationFrame(step);
      }
    }
    requestAnimationFrame(step);
  }

  function spawnLoop(){
    if(!S.running) return;

    // ğŸ”’ Boss éšæ®µï¼šåªå…è¨± Boss å­˜åœ¨ï¼›å¦‚æœæ²’åœ¨å ´å°±è£œä¸€éš»
    if (S.bossSpawned && !S.bossDefeated) {
      if (S.active === 0 && !S.spawnLocked) {
        spawnEnemy(true);                // ä¸€å®šç”Ÿ Boss
      }
      setTimeout(spawnLoop, 500 + Math.random()*400);
      return;
    }

    // â€”â€” ä¸€èˆ¬ç¯€å¥ï¼ˆé‚„æ²’é€²å…¥ Boss éšæ®µï¼‰â€”â€”
    if (S.active === 0 && !S.spawnLocked) {
      if (S.queueBoss && !S.bossSpawned && S.score === (S.goal - 1)) {
        S.queueBoss = false;
        spawnEnemy(true);                // å¼·åˆ¶ Boss
      } else {
        spawnEnemy(false);               // æ­£å¸¸ asan
      }
    }

    let delay = 600 + Math.random()*700;
    if (!S.bossSpawned && (S.score >= S.goal - 2)) {
      delay = 300 + Math.random()*400;  // æ¥è¿‘ Boss æ™‚æ›´å¿«
    }
    setTimeout(spawnLoop, delay);
  }

  const PLAYER_VOICES = { kick: ["kick_01.ogg","kick_02.ogg","kick_03.ogg"] };
  function playPlayerVoice(type){
    const arr = PLAYER_VOICES[type]; if(!arr) return;
    const f = arr[Math.floor(Math.random()*arr.length)];
    const a = new Audio("assets/sounds/player/" + f); a.volume = 0.8; a.play().catch(()=>{});
  }

  // ç©å®¶å…¥å ´èªéŸ³ï¼ˆæ¯å€‹è§’è‰²å°æ‡‰å›ºå®šä¸€æ”¯ï¼‰
  const PLAYER_INTRO_VOICE = {
    'male-longdress': 'assets/sounds/player/kick_01.ogg',
    'pregnant':       'assets/sounds/player/kick_02.ogg',
    'hs-girl':        'assets/sounds/player/kick_03.ogg'
  };

  // åªæ’­ä¸€æ¬¡çš„å…¥å ´èªéŸ³
  function playPlayerIntroVoiceOnce(){
    if (S.playerIntroPlayed) return;
    const src = PLAYER_INTRO_VOICE[S.avatar] || PLAYER_INTRO_VOICE['male-longdress'];
    const a = new Audio(src);
    a.volume = 0.85;
    a.play().catch(()=>{});
    S.playerIntroPlayed = true;
  }

  function doKick(){
    if(!S.running || S.kickWindow) return;
    S.kickSeq += 1;
    S.kickWindow = true;
    player.classList.add('kicking');
    hudState.textContent = 'å‡ºè…³ï¼';

    playKick();
    // playPlayerVoice("kick");
    speakAssertive('é£›è¸¢');

    const pr = player.getBoundingClientRect();
    const gr = stage.getBoundingClientRect();

    const { w: cardW, h: cardH } = cardSize(false);
    const kbw = Math.max(80, Math.round(cardW * 0.9));
    const kbh = Math.max(100, Math.round(cardH * 0.6));

    let kbLeft = (pr.left - gr.left) + pr.width - 6;
    let kbBottom = 18;

    const maxLeft = stage.clientWidth - kbw - 6;
    kbLeft = Math.max(6, Math.min(maxLeft, kbLeft));

    kickbox.style.width  = kbw + 'px';
    kickbox.style.height = kbh + 'px';
    kickbox.style.left   = kbLeft + 'px';
    kickbox.style.bottom = kbBottom + 'px';
    kickbox.classList.add('show');

    setTimeout(()=>{
      S.kickWindow = false;
      player.classList.remove('kicking');
      kickbox.classList.remove('show');
    }, 320);
  }

  // é˜¿æ¡‘è…³æ­¥
  const ASAN_STEPS = ["asan_step_01.ogg","asan_step_02.ogg"];
  const BOSS_STEPS = ["asan_boss_step_01.ogg","asan_boss_step_02.ogg"];

  // ç©å®¶èµ°è·¯éŸ³æ•ˆ
  const playPlayerStep = makeSfxPlayer("assets/sounds/player/step.ogg", 0.7, 100);

  // â€”â€” ç¯€æµçš„æ–¹å‘æ’­å ±ï¼ˆå‰é€²/å¾Œé€€ï¼‰â€”â€”
  let __lastMoveAnnounceAt = 0;
  let __lastMoveDir = 0; // -1 å¾Œé€€ / +1 å‰é€²
  function announceMove(dx){
    if (SR_VERBOSITY === 'none') return;
    const now = performance.now();
    const dir = dx > 0 ? 1 : -1;
    if (dir !== __lastMoveDir || now - __lastMoveAnnounceAt > 700){
      speakPolite(dir > 0 ? 'å‰é€²' : 'å¾Œé€€');
      __lastMoveAnnounceAt = now;
      __lastMoveDir = dir;
    }
  }

  function move(dx){
    const gw=stage.clientWidth, pw=player.clientWidth;
    const pr=player.getBoundingClientRect(), gr=stage.getBoundingClientRect();
    let x=(pr.left-gr.left)+dx;
    x=Math.max(6,Math.min(gw-pw-6,x));
    player.style.left=(x+pw/2)+'px';

    player.classList.add('walking');
    setTimeout(()=> player.classList.remove('walking'), 300);
    playPlayerStep();
    announceMove(dx);
  }

  // â€”â€” å¼·åŠ›å°é– contenteditable çš„è¼¸å…¥ â€”â€” //
  stage.addEventListener('beforeinput', e => { e.preventDefault(); }, true);
  stage.addEventListener('input', e => {
    e.preventDefault();
    if (stage.childNodes.length > 0) {
      [...stage.childNodes].forEach(n=>{ if (n.nodeType === Node.TEXT_NODE) n.remove(); });
    }
  });

  function isTypingTarget(el){
    if (!el) return false;
    const tag = el.tagName;
    if (tag === 'INPUT' || tag === 'TEXTAREA') return true;
    if (el.isContentEditable && el !== stage) return true;
    return false;
  }

  function isKickKey(e){
    return e.code === 'Space' || e.code === 'Enter' || e.code === 'NumpadEnter' ||
           e.code === 'KeyZ'  || e.key  === 'z'    || e.key  === 'Z';
  }

  // â€”â€” å…¨åŸŸæ””éµï¼ˆåªåœ¨ S.running æ™‚ä½œç”¨ï¼‰â€”â€”
  window.addEventListener('keydown', (e)=>{
    if (!S.running) return;
    if (isTypingTarget(e.target)) return;

    if (e.code === 'ArrowLeft') {
      move(-24); e.preventDefault();
    } else if (e.code === 'ArrowRight') {
      move(24); e.preventDefault();
    } else if (isKickKey(e)) {
      e.preventDefault();
      requestAnimationFrame(()=> doKick());
    }
  });
})();
</script>
<!-- footer -->
<footer role="contentinfo" class="footer" tabindex="0">
  <p>Â© 2025 é–‹ç™¼è€…ï¼šLÃ®m A-kÃ¢uï¼ˆæ—é˜¿çŒ´ï¼‰ & Kim Chioï¼ˆé‡‘è•‰ï¼‰ã€‚</p>
</footer>
</body>
</html>

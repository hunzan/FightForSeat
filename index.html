<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>擊退搶位奧俗辣（Àu-sut-á）Fight For Seat</title>
        <!-- ✅ Google AdSense 網站驗證 -->
  <meta name="google-site-verification" content="AbCdEfGhIjKlMnOpQrStUvWxYz1234567890" />

    <!-- ✅ AdSense 全域載入：只需一次 -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4184107654032285"
          crossorigin="anonymous"></script>
  <meta name="theme-color" content="#0b0d10" />
<style>
  :root{
    --bg:#0b0d10; --fg:#e9eef5; --muted:#b6c0cf; --accent:#ffd452; --danger:#ff5d6e; --glass:rgba(255,255,255,.06);
    --card-w: 150px;   /* 玩家 & 小怪卡片寬 */
    --card-h: 240px;   /* 玩家 & 小怪卡片高 */
    --boss-w: 210px;   /* Boss 寬 */
    --boss-h: 336px;   /* Boss 高 */
  }
  *{box-sizing:border-box}

  /* === NEW: 讓整頁改成垂直 flex，主內容撐開，footer 貼底 === */
  html,body{height:100%}
  body{
    margin:0;
    background:#0b0d10;
    color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Helvetica,Arial,sans-serif;
    display:flex;               /* NEW */
    flex-direction:column;      /* NEW */
    min-height:100%;            /* NEW：保險 */
  }

  header{text-align:center;padding:1rem}
  h1{margin:0;font-size:1.8rem}

  /* ====== 共用卡片 / 版面 ====== */
  .container{
    max-width:980px;
    margin:0 auto;
    padding:0 12px 24px;
    flex:1 0 auto;             /* NEW：把容器當主內容，撐開中間空間 */
  }
  .card{background:var(--glass);border:1px solid rgba(255,255,255,.14);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .hint{color:var(--muted)}

  /* ====== 設定（選角） ====== */
  #setup{padding:16px;display:grid;gap:16px}
  .grid-2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .roster{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .choice{position:relative;border-radius:14px;overflow:hidden;border:2px solid transparent}
  .choice input{position:absolute;inset:0;opacity:0}
  .face{aspect-ratio:3/4;background:linear-gradient(180deg,#30384a,#202634);display:grid;place-items:center}
  .face img{width:100%;height:100%;object-fit:cover}
  .label{padding:8px 10px;background:#111;display:flex;gap:8px;align-items:center}
  .choice:has(input:focus-visible){outline:3px solid var(--accent);outline-offset:3px}
  .choice:has(input:checked){border-color:var(--accent);box-shadow:0 0 0 4px rgba(255,212,82,.15)}
  input[type="text"],select{width:100%;padding:.7rem .8rem;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);color:var(--fg)}
  .actions{display:flex;gap:12px;justify-content:flex-end;align-items:center}
  button{appearance:none;border:0;border-radius:14px;padding:.85rem 1.1rem;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--accent);color:#111}
  .btn-ghost{background:transparent;color:var(--fg);border:1px solid rgba(255,255,255,.2)}

  /* ====== 遊戲舞台 ====== */
  #hud{display:flex;justify-content:space-between;align-items:center;padding:.5rem 1rem;background:rgba(255,255,255,.08);border-radius:12px 12px 0 0}
  #hud span{margin-right:1rem}
  #stage{
    user-select:none;
    -webkit-user-select:none;
    outline:0;
    position:relative;
    height:64vh;min-height:380px;
    overflow:hidden;
    border:2px solid #555;border-radius:0 0 12px 12px;
    background: url("assets/bg/mrt_carriage.webp") center center / cover no-repeat;
    margin-bottom: 0;            /* NEW：避免舞台底下再長出多餘空白 */
  }
  .player,.enemy{
    position:absolute;
    bottom:18px;
    width:var(--card-w);
    height:var(--card-h);
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    transition:transform .25s ease, opacity .25s ease;
  }
  .enemy.boss{
    width:var(--boss-w);
    height:var(--boss-h);
    filter:drop-shadow(0 6px 12px rgba(255,0,0,.35));
  }
  .player { left: calc(50% - 40px); transform: translateX(-50%); }

  @keyframes kick-pop {
    0%   { transform: translateX(-50%) scale(0.6); opacity: 0; }
    30%  { transform: translateX(-50%) scale(1.2); opacity: 1; text-shadow: 0 0 12px rgba(255,212,82,.8); }
    60%  { transform: translateX(-50%) scale(1);   opacity: 1; text-shadow: 0 0 20px rgba(255,212,82,.6); }
    100% { transform: translateX(-50%) scale(1);   opacity: 0; text-shadow: none; }
  }
  .player.kicking::after{
    content:"飛踢💥";
    position:absolute;
    top:-50px;
    left:50%;
    transform:translateX(-50%);
    background:var(--accent);
    color:#111;
    padding:6px 14px;
    border-radius:14px;
    font-weight:1000;
    font-size:1.2rem;
    white-space:nowrap;
    animation: kick-pop 2.0s ease forwards;
  }
  .enemy.ko{transform:translateY(-150px) rotate(45deg);opacity:0}

  .overlay{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.7);color:#fff}
  .overlay.show{display:grid}
  .panel{background:#111;padding:1rem 1.5rem;border-radius:12px;text-align:center}

  /* 倒數提示 */
  #countdown{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45)}
  #countdown.show{display:grid}
  #countdown b{font-size:56px}

  /* 飛踢動畫 */
  @keyframes kick-jump {
    0%   { transform: translateX(-50%) translateY(0) rotate(0); }
    25%  { transform: translateX(calc(-50% + 10px)) translateY(-48px) rotate(-18deg); }
    45%  { transform: translateX(calc(-50% + 16px)) translateY(-62px) rotate(-22deg); }
    70%  { transform: translateX(calc(-50% + 8px)) translateY(-28px) rotate(-8deg); }
    100% { transform: translateX(-50%) translateY(0) rotate(0); }
  }
  .player.kicking { animation: kick-jump 0.45s ease; transform-origin: 60% 80%; }

  /* 踢擊判定框 */
  .kickbox {
    position:absolute; bottom:18px; height:84px; width:68px;
    background: transparent; border: 1px dashed transparent;
    pointer-events:none; display:none; border-radius:8px;
  }
  .kickbox.show { display:block; }

  @keyframes hit-flash { 0%{ box-shadow: inset 0 0 0 rgba(255,0,0,0)}
    40%{ box-shadow: inset 0 0 40px rgba(255,0,0,.8)}
    70%{ box-shadow: inset 0 0 25px rgba(255,0,0,.6)}
    100%{ box-shadow:none}}
  .player.hit { animation: hit-flash 0.5s ease; }

  /* 玩家被撞動畫 */
  @keyframes player-knock-fall-left {
    0%   { transform: translateX(-50%) translateY(0) rotate(0deg) scale(1,1); }
    20%  { transform: translateX(-50%) translateY(30px) rotate(-90deg) scale(1.05,.85);}
    45%  { transform: translateX(-50%) translateY(-20px) rotate(-70deg) scale(.95,1.05);}
    65%  { transform: translateX(-50%) translateY(15px) rotate(-30deg) scale(1.02,.9);}
    80%  { transform: translateX(-50%) translateY(-10px) rotate(-10deg) scale(.98,1.02);}
    100% { transform: translateX(-50%) translateY(0) rotate(0deg) scale(1,1);}
  }
  .player.hit-knock { animation: player-knock-fall-left 1.1s cubic-bezier(.25,.9,.35,1.3); will-change: transform;}

  @keyframes walk-sway { 0%{transform:translate(0,0) rotate(0)}
    25%{transform:translate(-3px,-2px) rotate(-2deg)}
    50%{transform:translate(0,0) rotate(0)}
    75%{transform:translate(3px,2px) rotate(2deg)}
    100%{transform:translate(0,0) rotate(0)}}
  .enemy { animation: walk-sway 0.6s infinite ease-in-out; }

  .enemy.boss { animation: walk-sway-boss 0.7s infinite ease-in-out; }
  @keyframes walk-sway-boss { 0%{transform:translate(0,0) rotate(0)}
    25%{transform:translate(-6px,-4px) rotate(-4deg)}
    50%{transform:translate(0,0) rotate(0)}
    75%{transform:translate(6px,4px) rotate(4deg)}
    100%{transform:translate(0,0) rotate(0)}}

  /* 小怪被踢中 → 飛走旋轉 */
  .enemy.ko { transform-origin:center; animation: knockback-spin 2s cubic-bezier(.25,1.4,.45,1) forwards; will-change: transform; }
  .enemy.boss.ko { animation: boss-knockback-spin 2.5s cubic-bezier(.25,1.4,.45,1) forwards; }
  @keyframes knockback-spin {
    0%{ transform: translate(0,0) rotate(0) scale(1); opacity:1;}
    25%{ transform: translate(80px,-50px) rotate(180deg) scale(1.05);}
    50%{ transform: translate(200px,-140px) rotate(360deg) scale(0.98);}
    75%{ transform: translate(320px,-200px) rotate(540deg) scale(0.96);}
    100%{transform: translate(480px,-260px) rotate(720deg) scale(0.95); opacity:0;}
  }
  @keyframes boss-knockback-spin {
    0%{ transform: translate(0,0) rotate(0) scale(1); opacity:1;}
    25%{ transform: translate(100px,-70px) rotate(270deg) scale(1.05);}
    50%{ transform: translate(240px,-160px) rotate(540deg) scale(0.98);}
    75%{ transform: translate(380px,-240px) rotate(810deg) scale(0.96);}
    100%{transform: translate(600px,-320px) rotate(1080deg) scale(0.94); opacity:0;}
  }

  .sr-only{
    position:absolute !important;
    width:1px;height:1px;overflow:hidden;
    clip:rect(1px,1px,1px,1px);white-space:nowrap;
    border:0;padding:0;margin:-1px;
  }
  @keyframes boss-flinch {
    0% { transform: translate(0,0) rotate(0); }
    30% { transform: translate(8px,-4px) rotate(3deg); }
    100% { transform: translate(0,0) rotate(0); }
  }
  .enemy.boss.flinch { animation: boss-flinch .18s ease; }

  /* 整頁垂直排列，主內容撐開，中間不留莫名空白 */
  html, body { height: 100%; }
  body {
    margin: 0;
    display: flex;
    flex-direction: column;
    min-height: 100%;
  }

  /* 你的主容器（main.container）當主內容，撐開中間空間 */
  .container { flex: 1 0 auto; }

  /* 舞台底下不要再長額外空白 */
  #stage { margin-bottom: 0; }

  /* 區塊間距用小量控制即可 */
  #gameWrap { margin-top: 16px; }
  .ad-container { margin-top: 12px; }

  /* footer 造型（12pt/置中/淡邊） */
  .footer {
    width: 100%;
    text-align: center;
    color: #777;
    font-size: 12pt;
    line-height: 1.6;
    margin-top: 12px;         /* 想更貼就改成 8px 或 0 */
    padding: 16px 0;
    border-top: 1px solid rgba(0,0,0,0.1);
    background: rgba(255,255,255,0.05);
    flex-shrink: 0;           /* 不要被撐開 */
  }
  .footer p { margin: 0; }
  .ad-footer { margin-top: .5rem; }
</style>
</head>
<body>
  <header>
    <h1>擊退搶位奧俗辣（Àu-sut-á）Fight For Seat <small style="font-weight:400;color:var(--muted)">選角 👉 對決</small></h1>
    <p class="hint">操作方式：按空白鍵／Enter／<b>Z</b>「飛踢」💥　用左右鍵 ⬅️➡️ 移動</p>
  </header>
  <!-- 給螢幕閱讀器的整頁導覽說明 -->
  <p id="sr-page-intro" class="sr-only">
    這是一款卡片對決遊戲。先在本頁選擇角色與任務目標，
    按「開始遊戲」進入對決。進入遊戲後，使用左右方向鍵移動位置，
    NVDA 使用者按英文 Z 鍵或 Enter 鍵使出飛踢，
    目標是把一定數量的阿喪踢飛，最後會出現 Boss 級阿喪，需要連環踢才能擊退。
  </p>

  <main class="container">
    <!-- ====== 選角區 ====== -->
    <section id="setup" class="card" aria-label="選角與設定"
         aria-labelledby="choose-title"
         aria-describedby="sr-page-intro roster-help">
　　<h2 id="choose-title" class="sr-only">選角與任務設定</h2>
      <p id="roster-help" class="sr-only">
        先輸入暱稱並設定任務目標 KO 數，再到單選清單，共有三個角色可選擇，請移動左右鍵框選你要的角色卡，再按 Tab 鍵到「開始遊戲」按鈕。
      </p>
      <div class="grid-2">
        <div>
          <label for="nickname">玩家暱稱</label>
          <input id="nickname" type="text" placeholder="輸入您的暱稱（可留白）" maxlength="18" />
        </div>
        <div>
          <label for="goal">任務目標（KO 數）</label>
          <select id="goal">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="15">15</option>
          </select>
        </div>
      </div>

      <p class="hint">請選擇您的角色卡（每個人都是 No.1）</p>
      <div class="roster" role="radiogroup" aria-label="選角清單" aria-describedby="roster-help">
        <label class="choice" role="listitem">
          <input type="radio" name="avatar" value="male-longdress" checked aria-label="長髮綁馬尾長黑裙美男子，提著白色精品紙袋，卡片標語：英雄有時是穿長裙。小短句：物理治療超有效！" />
          <div class="face"><img alt="長髮綁馬尾長黑裙美男子" src="assets/players/male-longdress.webp" onerror="this.remove()"></div>
          <div class="label">😆<b>物理治療超有效！</b></div>
        </label>
        <label class="choice" role="listitem">
          <input type="radio" name="avatar" value="pregnant" aria-label="中長髮溫柔孕婦，卡片標語：為守護寶寶而戰。小短句：正所謂，為母則強。" />
          <div class="face"><img alt="中長髮溫柔孕婦" src="assets/players/pregnant.webp" onerror="this.remove()"></div>
          <div class="label">❤️<b>正所謂：為母則強！</b></div>
        </label>
        <label class="choice" role="listitem">
          <input type="radio" name="avatar" value="hs-girl" aria-label="文青女高中生，戴眼鏡，綁兩根辮子，卡片標語：體育課很重要唷。小短句：別以為女生好欺負。" />
          <div class="face"><img alt="文青女高中生" src="assets/players/hs-girl.webp" onerror="this.remove()"></div>
          <div class="label">🌸<b>別以為女生好欺負！</b></div>
        </label>
      </div>

      <div class="actions">
        <button id="btnStart" class="btn-primary">開始遊戲</button>
      </div>
    </section>

    <!-- ====== 遊戲區 ====== -->
    <section id="gameWrap" class="card" aria-label="捷運對決區" style="margin-top:16px;display:none">
      <div id="hud" aria-live="polite" aria-atomic="true">
        <div>
          <span id="hudName">暱稱：—</span>
          <span>目標：<b id="hudGoal">10</b></span>
          <span>生命：<b id="hudLives">3</b></span>
        </div>
        <div>
          <span>已 KO：<b id="hudScore">0</b></span>
          <span>狀態：<b id="hudState">倒數</b></span>
          <button id="btnHome" class="btn-ghost" style="margin-left:12px">回選角</button>
        </div>
      </div>
      <button id="focusGame" class="sr-only">
        啟用遊戲控制（NVDA 使用者按 Enter 或英文 Z 空白鍵執行飛踢）
      </button>

      <div
        id="stage"
        tabindex="0"
        role="application"
        contenteditable="true"
        spellcheck="false"
        aria-label="卡片對決舞台。按英文 Z 或 Enter 使出飛踢；左右方向鍵移動。"
        aria-keyshortcuts="Z Space Enter">
        <div id="player" class="player" aria-label="玩家角色"></div>
        <div id="kickbox" class="kickbox" aria-hidden="true"></div>
        <div id="countdown"><b>3</b></div>
      </div>

      <div id="over" class="overlay" aria-hidden="true">
        <div class="panel"
             id="dialogPanel"
             role="dialog"
             aria-modal="true"
             aria-labelledby="overTitle"
             aria-describedby="overMsg"
             tabindex="-1">
          <h2 id="overTitle">結算</h2>
          <p id="overMsg">—</p>
          <div style="display:flex;gap:10px;justify-content:center">
            <button id="btnReplay" class="btn-primary">再戰一場</button>
            <button id="btnHome2" class="btn-ghost">回選角</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Live regions -->
    <div id="sr-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    <div id="sr-live-assertive" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
                <!-- ✅ 廣告區塊 1：放在結果下方 -->
    <div class="ad-container">
      <ins class="adsbygoogle"
           style="display:block; text-align:center;"
           data-ad-client="ca-pub-4184107654032285"
           data-ad-slot="9988828914"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </main>

<script>
(function(){
  const $ = (s,el=document)=>el.querySelector(s); const $$ = (s,el=document)=>[...el.querySelectorAll(s)];
  const START_GRACE_MS = 900; // 開場保護

  // ====== DOM ======
  const setup = $('#setup');
  const btnStart = $('#btnStart');
  const nickEl = $('#nickname');
  const goalSel = $('#goal');

  const gameWrap = $('#gameWrap');
  const stage = $('#stage');
  const player = $('#player');
  const hudName = $('#hudName');
  const hudGoal = $('#hudGoal');
  const hudScore = $('#hudScore');
  const hudState = $('#hudState');
  const btnHome = $('#btnHome');
  const btnHome2 = $('#btnHome2');
  const btnReplay = $('#btnReplay');
  const overlay = $('#over');
  const overTitle = $('#overTitle');
  const overMsg = $('#overMsg');
  const countdown = $('#countdown');
  const BOSS_HITS = 3;
  const kickbox = $('#kickbox');
  const hudLives = $('#hudLives');
  const srLive = document.getElementById('sr-live');
  const srLiveAssert = document.getElementById('sr-live-assertive');
  const dialogPanel = document.getElementById('dialogPanel');
  let __preDialogFocused = null;

  // ===== 語音工具 =====
  // 語音冗長度（'brief' = 左右鍵會短唸；'none' = 完全不唸）
  let SR_VERBOSITY = 'brief';

  function speakPolite(msg){
    srLive.textContent = '';
    setTimeout(()=>{ srLive.textContent = msg; }, 30);
  }
  function speakAssertive(msg){
    srLiveAssert.textContent = '';
    setTimeout(()=>{ srLiveAssert.textContent = msg; }, 30);
  }

  function speak(msg){ // 向後相容
    speakPolite(msg);
  }

  // 讓「啟用控制」按鈕把焦點送進舞台
  const btnFocus = document.getElementById('focusGame');
  if (btnFocus) {
    btnFocus.addEventListener('click', () => { focusStageSoon(); });
  }

  // 每次開始或回到遊戲，都主動把焦點放進舞台
  function focusStageSoon(){
    setTimeout(() => { stage.focus(); }, 100);
  }

  // ===== 背景音樂控制 =====
  let bgm = null, bgmUnlocked = false;
  function createBgm() { const a = new Audio("assets/sounds/war.ogg"); a.loop = true; a.volume = 0.7; return a; }
  function playBgm() { if (!bgm) bgm = createBgm(); if (bgmUnlocked) bgm.play().catch(()=>{}); }
  function stopBgm() { if (bgm) { bgm.pause(); bgm.currentTime = 0; } }
  function ensureBgm() {
    if (!bgm) bgm = createBgm();
    const tryPlay = () => {
      bgm.play().then(() => {
        bgmUnlocked = true;
        window.removeEventListener('pointerdown', tryPlay);
        window.removeEventListener('keydown', tryPlay);
      }).catch(()=>{});
    };
    tryPlay();
    window.addEventListener('pointerdown', tryPlay, { once: true });
    window.addEventListener('keydown', tryPlay, { once: true });
  }
  ensureBgm();

  // ===== 選角音效 =====
  const selectSfx = new Audio("assets/sounds/ui_select.ogg");
  selectSfx.volume = 0.6;
  $$('input[name="avatar"]').forEach(radio=>{
    radio.addEventListener('change', ()=>{
      selectSfx.currentTime = 0; selectSfx.play().catch(()=>{});
      const name = radio.closest('.choice')?.querySelector('.label b')?.textContent || '角色';
      speakPolite(`已選擇：${name}`);
    });
  });
  goalSel.addEventListener('change', ()=>{ speakPolite(`目標設定為 ${goalSel.value} 隻`); });

  // ===== 聲音（台詞） =====
  const VOICES = {
    atk:["asan_atk_01.ogg","asan_atk_02.ogg","asan_atk_03.ogg","asan_atk_04.ogg","asan_atk_05.ogg"],
    spc_boa:["asan_spc_boa_01.ogg","asan_spc_boa_02.ogg","asan_spc_boa_03.ogg"],
    spc_team:["asan_spc_team_01.ogg","asan_spc_team_02.ogg","asan_spc_team_03.ogg"],
    ko:["asan_ko_01.ogg","asan_ko_02.ogg","asan_ko_03.ogg","asan_ko_04.ogg","asan_ko_05.ogg"],
    boss_intro:["asan_boss_intro.ogg"], boss_ko:["asan_boss_ko.ogg"]
  };
  const pick = a=>a[Math.floor(Math.random()*a.length)];
  let lastVoiceAt = 0;
  function playVoice(type){
    const arr = VOICES[type]; if(!arr) return;
    const now = performance.now();
    if (now - lastVoiceAt < 700) return;
    lastVoiceAt = now;
    const a = new Audio('assets/sounds/asan/' + pick(arr)); a.volume = 0.8; a.play().catch(()=>{});
  }
  function makeSfxPlayer(path, vol = 0.8, gap = 80){
    let last = 0;
    return function(){
      const now = performance.now(); if (now - last < gap) return; last = now;
      const a = new Audio(path); a.volume = Math.max(0, Math.min(1, vol)); a.play().catch(()=>{});
    }
  }
  const playKick = makeSfxPlayer("assets/sounds/kick.ogg", 0.75, 80);
  const playHit  = makeSfxPlayer("assets/sounds/hit.ogg",  0.85, 80);
  const playFail = makeSfxPlayer("assets/sounds/fail.ogg", 0.85, 120);
  const playWin = makeSfxPlayer("assets/sounds/win.ogg", 0.9, 300);  // 勝利（過關）音效
  const playLose = makeSfxPlayer("assets/sounds/final_fail.ogg",  0.9, 300);

  const __preloadBoss = new Image(); __preloadBoss.src = 'assets/enemy/asan_boss.webp';

  function cssNum(el, prop){ const v = getComputedStyle(el).getPropertyValue(prop); return parseFloat(v) || 0; }
  function cardSize(isBoss){
    const w = cssNum(player, isBoss ? '--boss-w' : '--card-w') || (isBoss ? 116 : player.clientWidth);
    const h = cssNum(player, isBoss ? '--boss-h' : '--card-h') || (isBoss ? 180 : player.clientHeight);
    return { w, h };
  }

  // ===== 狀態 =====
  const S = {
    running:false, score:0, goal:10, kickWindow:false,
    nick:'', avatar:'male-longdress', startTime:0, bossDefeated:false,
    bossSpawned:false, lives:3, active:0, spawnLocked:false, queueBoss:false,
    kickSeq: 0,
    playerIntroPlayed: false
  };

  function getAvatarPath(val){
    const map = {
      'male-longdress':'assets/players/male-longdress.webp',
      'pregnant':'assets/players/pregnant.webp',
      'hs-girl':'assets/players/hs-girl.webp'
    };
    return map[val] || map['male-longdress'];
  }

  // ===== 流程控制 =====
  btnStart.addEventListener('click', ()=>{
    playBgm();
    S.avatar = ($('input[name="avatar"]:checked')||{}).value || 'male-longdress';
    S.nick = (nickEl.value||'').trim();
    S.goal = Number(goalSel.value||10);

    hudName.textContent = '暱稱：' + (S.nick || '—');
    hudGoal.textContent = String(S.goal);
    hudScore.textContent = '0';
    hudState.textContent = '倒數';

    setup.style.display='none';
    gameWrap.style.display='block';
    player.style.backgroundImage = `url(${getAvatarPath(S.avatar)})`;

    const gw = stage.clientWidth; const pw = player.clientWidth;
    const initX = gw / 3 - pw / 2; player.style.left = initX + 'px';
    player.classList.remove('kicking');

    focusStageSoon();
    countdown.classList.add('show');
    const cd = countdown.querySelector('b');
    cd.textContent='3';
    setTimeout(()=>{cd.textContent='2';},400);
    setTimeout(()=>{cd.textContent='1';},800);
    setTimeout(()=>{
      countdown.classList.remove('show');
      startGame();
      focusStageSoon();
    },1200);

    speakPolite('進入對決。按 Z 或空白鍵或 Enter 飛踢，左右鍵移動。若未反應，請切換為焦點模式再試一次。');
  });

  function backToSetup(){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
    gameWrap.style.display='none';
    setup.style.display='grid';
  }
  btnHome.addEventListener('click', backToSetup);
  btnHome2.addEventListener('click', backToSetup);

  // ====== Dialog：開關/朗讀/鎖焦 ======
  function openDialogAndAnnounce(titleText, msgText){
    if (titleText) overTitle.textContent = titleText;
    if (msgText)   overMsg.textContent   = msgText;

    overlay.classList.add('show');
    overlay.removeAttribute('aria-hidden');

    __preDialogFocused = document.activeElement;
    dialogPanel.focus();

    // 出現視窗時才播結束音效
    if (/過關/.test(overTitle.textContent)) {
      playWin();
    } else if (/遊戲結束/.test(overTitle.textContent)) {
      playLose();
    }

    // 立即 assertive 朗讀
    speakAssertive(`${overTitle.textContent}。${overMsg.textContent}。按 Tab 可在「再戰一場」與「回選角」之間切換。`);
  }
  function closeDialogAndRestoreFocus(){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
    if (__preDialogFocused && typeof __preDialogFocused.focus === 'function') {
      __preDialogFocused.focus();
    } else {
      stage.focus();
    }
  }
  dialogPanel.addEventListener('keydown', (e)=>{
    if (e.key === 'Tab'){
      const focusables = [btnReplay, btnHome2].filter(Boolean);
      if (!focusables.length) return;
      const idx = focusables.indexOf(document.activeElement);
      if (e.shiftKey){
        e.preventDefault();
        const prev = idx <= 0 ? focusables.length - 1 : idx - 1;
        focusables[prev].focus();
      } else {
        e.preventDefault();
        const next = idx === focusables.length - 1 ? 0 : idx + 1;
        focusables[next].focus();
      }
    } else if (e.key === 'Escape'){
      e.preventDefault();
      closeDialogAndRestoreFocus();
    }
  });

  btnReplay.addEventListener('click', ()=>{
    closeDialogAndRestoreFocus();
    startGame();
  });

  // ====== 遊戲主流程 ======
  function startGame(){
    clearEnemies();
    S.running = true;
    S.score = 0;
    S.lives = 3;
    S.kickWindow = false;
    S.startTime = performance.now();
    S.bossSpawned = false;
    S.bossDefeated = false;
    S.active = 0;
    S.spawnLocked = false;
    S.queueBoss = false;
    S.playerIntroPlayed = false;
    stage.setAttribute('contenteditable','false'); // 關掉編輯，避免輸入
    hudScore.textContent = '0';
    hudLives.textContent = S.lives;
    hudState.textContent = '開打！';
    playPlayerIntroVoiceOnce();  // ★ 入場語音只播一次（此局）
    focusStageSoon();
    setTimeout(spawnLoop, 1200);
  }
  function endGame(){ S.running=false; }
  function clearEnemies(){ $$('.enemy',stage).forEach(e=>e.remove()); }

  function rect(el){ return el.getBoundingClientRect(); }
  function collide(a,b){ return !(a.right<b.left||a.left>b.right||a.bottom<b.top||a.top>b.bottom); }

  function spawnEnemy(forceBoss=false){
    let isBoss = false;
    if (forceBoss && !S.bossSpawned && S.score >= (S.goal - 1)) {
      isBoss = true;
      S.bossSpawned = true;
    }

    const e = document.createElement('div');
    let hp = isBoss ? BOSS_HITS : 1;   // ← Boss 要打 3 次，小怪 1 次
    e.className = 'enemy' + (isBoss ? ' boss' : '');
    e.style.backgroundImage = `url(${isBoss ? 'assets/enemy/asan_boss.webp' : 'assets/enemy/asan.webp'})`;
    stage.appendChild(e);
    S.active++;

    let voiceAudio = null;
    let stepAudio  = null;

    if (isBoss) {
      voiceAudio = new Audio('assets/sounds/asan/' + pick(VOICES.boss_intro));
    } else {
      if (Math.random() < 0.15)      voiceAudio = new Audio('assets/sounds/asan/' + pick(VOICES.spc_boa));
      else if (Math.random() < 0.12) voiceAudio = new Audio('assets/sounds/asan/' + pick(VOICES.spc_team));
      else if (Math.random() < 0.20) voiceAudio = new Audio('assets/sounds/asan/' + pick(VOICES.atk));
    }
    if (voiceAudio) voiceAudio.play().catch(()=>{});

    function playEnemyStep(){
      if (stepAudio) { try{ stepAudio.pause(); }catch{} }
      stepAudio = new Audio("assets/sounds/asan/steps/" + pick(isBoss ? BOSS_STEPS : ASAN_STEPS));
      stepAudio.volume = isBoss ? 0.85 : 0.65;
      stepAudio.play().catch(()=>{});
    }

    const base  = isBoss ? 120 : 140;
    let speed   = base + Math.random()*25 + (S.score * 2);
    speed = Math.min(speed, 260);

    const { w: enemyW } = cardSize(isBoss);
    const off = Math.round(enemyW * 2.1);
    let pos = -off;
    e.style.right = pos + 'px';

    let removed = false;
    let dead    = false;

    function cleanup(){
      if (removed) return;
      removed = true;
      try { if (voiceAudio) voiceAudio.pause(); } catch {}
      try { if (stepAudio)  stepAudio.pause();  } catch {}
      voiceAudio = null; stepAudio  = null;
      if (e.parentNode) e.remove();
      S.active = Math.max(0, S.active - 1);
    }

    let lastTs = null;
    let travel = 0;

  function step(ts){
    if (!S.running || removed) return;

    if (lastTs == null) { lastTs = ts; requestAnimationFrame(step); return; }
    const dt = (ts - lastTs) / 1000; lastTs = ts;

    pos += speed * dt;
    e.style.right = pos + 'px';

    travel += speed * dt;
    if (travel >= (isBoss ? 180 : 120)) { playEnemyStep(); travel = 0; }

    const pr = rect(player), er = rect(e);
    const now = performance.now();
    const underGrace = (now - S.startTime) < START_GRACE_MS;
    const kr = kickbox.getBoundingClientRect();

    // === 1) 先處理「踢擊命中」（維持你的 kickSeq 防連判）===
    if (S.kickWindow && !dead && collide(kr, er)) {

      // —— 同一腳只判一次 —— //
      if (e.dataset.lastKick === String(S.kickSeq)) {
        requestAnimationFrame(step);
        return;
      }
      e.dataset.lastKick = String(S.kickSeq);

      // 命中音效與舞台閃光
      playHit();
      stage.classList.add('hit-flash');
      setTimeout(()=> stage.classList.remove('hit-flash'), 250);

      if (isBoss) {
        // —— Boss 扣血，不立即死亡 —— //
        hp = Math.max(0, hp - 1);
        const done = BOSS_HITS - hp; // 已擊中次數
        hudState.textContent = `Boss 受創（${done}/${BOSS_HITS}）`;
        speakPolite(`命中 Boss，已擊中 ${done} 次，還需 ${hp} 次`);

        if (hp <= 0) {
          // 真正擊倒 Boss
          dead = true;
          try { if (voiceAudio) voiceAudio.pause(); } catch {}
          try { if (stepAudio)  stepAudio.pause();  } catch {}

          e.classList.add('ko');
          e.addEventListener('animationend', cleanup, { once: true });

          S.bossDefeated = true;                 // ← 標記 Boss 已被打倒
          S.score += 1;                          // 只有倒下時才+1
          hudScore.textContent = String(S.score);
          playVoice('boss_ko');

          // 判斷是否過關
          if (S.score >= S.goal) {
            // 延遲 3 秒再出現破關畫面與音效
            setTimeout(() => {
              openDialogAndAnnounce(
                '過關',
                `你成功擊退 ${S.goal} 隻奧俗辣（含 Boss 級別）！`
              );
              endGame();
            }, 3000); // ← 3000 毫秒 = 3 秒
            return;
          }
        } else {
          // ← Boss 扣到還沒死，做個微晃
          e.classList.add('flinch');
          setTimeout(()=> e.classList.remove('flinch'), 180);
          // Boss 不移除、不加分，繼續往前走
        }

      } else {
        // —— 小怪：一擊倒 —— //
        dead = true;

        try { if (voiceAudio) voiceAudio.pause(); } catch {}
        try { if (stepAudio)  stepAudio.pause();  } catch {}

        e.classList.add('ko');
        e.addEventListener('animationend', cleanup, { once: true });

        S.score += 1;
        hudScore.textContent = String(S.score);
        hudState.textContent = '踢中！';
        playVoice('ko');

        // 接 Boss 時機
        if (!S.bossSpawned && S.score === (S.goal - 1)) {
          S.spawnLocked = true;
          S.queueBoss   = true;
          setTimeout(()=>{ S.spawnLocked = false; }, 600);
        }
      }
    }

    // === 2) 🔹新增：被撞判定（只有「不在踢擊窗」時才會被撞）===
      if (!S.kickWindow && !dead && collide(pr, er) && !underGrace) {
        // 玩家受擊動畫/扣命（原樣）
        hudState.textContent = '被撞';
        playFail();
        speakAssertive('被撞倒');
        player.classList.remove('kicking','walking','hit-anim');
        player.classList.add('hit-knock');
        setTimeout(()=> player.classList.remove('hit-knock'), 1100);

        if (S.lives != null) {
          S.lives--;
          if (hudLives) hudLives.textContent = S.lives;
        }

        if (isBoss) {
          // Boss 不要被移除！只停掉聲音，並把位置稍微「推回去」
          try { if (voiceAudio) voiceAudio.pause(); } catch {}
          try { if (stepAudio)  stepAudio.pause();  } catch {}

          // 把 Boss 推回右邊一點，避免立刻二次撞到
          pos = Math.max(-20, pos - 60);      // 可依手感調整 60
          e.style.right = pos + 'px';

          // 給玩家短暫保護
          S.startTime = performance.now();

          // 重新開始腳步音（可選）
          stepAudio = null;
        } else {
          // 小怪照舊：被撞就消失
          try { if (voiceAudio) voiceAudio.pause(); } catch {}
          try { if (stepAudio)  stepAudio.pause();  } catch {}
          cleanup();
        }

        // 生命歸零處理
        if (S.lives != null && S.lives <= 0) {
          endGame();
          setTimeout(() => {
            openDialogAndAnnounce(
              '遊戲結束',
              isBoss ? 'Boss 阿桑把你撞飛啦！' : '阿桑撞翻你了！'
            );
          }, 3000);
          return;
        } else if (S.lives == null) {
          endGame();
          setTimeout(() => {
            openDialogAndAnnounce(
              '遊戲結束',
              isBoss ? 'Boss 阿桑把你撞飛啦！' : '阿桑撞翻你了！'
            );
          }, 3000);
          return;
        }
      }

      // 離場/續跑
      if (pos > stage.clientWidth) {
        cleanup();
      } else {
        requestAnimationFrame(step);
      }
    }
    requestAnimationFrame(step);
  }

  function spawnLoop(){
    if(!S.running) return;

    // 🔒 Boss 階段：只允許 Boss 存在；如果沒在場就補一隻
    if (S.bossSpawned && !S.bossDefeated) {
      if (S.active === 0 && !S.spawnLocked) {
        spawnEnemy(true);                // 一定生 Boss
      }
      setTimeout(spawnLoop, 500 + Math.random()*400);
      return;
    }

    // —— 一般節奏（還沒進入 Boss 階段）——
    if (S.active === 0 && !S.spawnLocked) {
      if (S.queueBoss && !S.bossSpawned && S.score === (S.goal - 1)) {
        S.queueBoss = false;
        spawnEnemy(true);                // 強制 Boss
      } else {
        spawnEnemy(false);               // 正常 asan
      }
    }

    let delay = 600 + Math.random()*700;
    if (!S.bossSpawned && (S.score >= S.goal - 2)) {
      delay = 300 + Math.random()*400;  // 接近 Boss 時更快
    }
    setTimeout(spawnLoop, delay);
  }

  const PLAYER_VOICES = { kick: ["kick_01.ogg","kick_02.ogg","kick_03.ogg"] };
  function playPlayerVoice(type){
    const arr = PLAYER_VOICES[type]; if(!arr) return;
    const f = arr[Math.floor(Math.random()*arr.length)];
    const a = new Audio("assets/sounds/player/" + f); a.volume = 0.8; a.play().catch(()=>{});
  }

  // 玩家入場語音（每個角色對應固定一支）
  const PLAYER_INTRO_VOICE = {
    'male-longdress': 'assets/sounds/player/kick_01.ogg',
    'pregnant':       'assets/sounds/player/kick_02.ogg',
    'hs-girl':        'assets/sounds/player/kick_03.ogg'
  };

  // 只播一次的入場語音
  function playPlayerIntroVoiceOnce(){
    if (S.playerIntroPlayed) return;
    const src = PLAYER_INTRO_VOICE[S.avatar] || PLAYER_INTRO_VOICE['male-longdress'];
    const a = new Audio(src);
    a.volume = 0.85;
    a.play().catch(()=>{});
    S.playerIntroPlayed = true;
  }

  function doKick(){
    if(!S.running || S.kickWindow) return;
    S.kickSeq += 1;
    S.kickWindow = true;
    player.classList.add('kicking');
    hudState.textContent = '出腳！';

    playKick();
    // playPlayerVoice("kick");
    speakAssertive('飛踢');

    const pr = player.getBoundingClientRect();
    const gr = stage.getBoundingClientRect();

    const { w: cardW, h: cardH } = cardSize(false);
    const kbw = Math.max(80, Math.round(cardW * 0.9));
    const kbh = Math.max(100, Math.round(cardH * 0.6));

    let kbLeft = (pr.left - gr.left) + pr.width - 6;
    let kbBottom = 18;

    const maxLeft = stage.clientWidth - kbw - 6;
    kbLeft = Math.max(6, Math.min(maxLeft, kbLeft));

    kickbox.style.width  = kbw + 'px';
    kickbox.style.height = kbh + 'px';
    kickbox.style.left   = kbLeft + 'px';
    kickbox.style.bottom = kbBottom + 'px';
    kickbox.classList.add('show');

    setTimeout(()=>{
      S.kickWindow = false;
      player.classList.remove('kicking');
      kickbox.classList.remove('show');
    }, 320);
  }

  // 阿桑腳步
  const ASAN_STEPS = ["asan_step_01.ogg","asan_step_02.ogg"];
  const BOSS_STEPS = ["asan_boss_step_01.ogg","asan_boss_step_02.ogg"];

  // 玩家走路音效
  const playPlayerStep = makeSfxPlayer("assets/sounds/player/step.ogg", 0.7, 100);

  // —— 節流的方向播報（前進/後退）——
  let __lastMoveAnnounceAt = 0;
  let __lastMoveDir = 0; // -1 後退 / +1 前進
  function announceMove(dx){
    if (SR_VERBOSITY === 'none') return;
    const now = performance.now();
    const dir = dx > 0 ? 1 : -1;
    if (dir !== __lastMoveDir || now - __lastMoveAnnounceAt > 700){
      speakPolite(dir > 0 ? '前進' : '後退');
      __lastMoveAnnounceAt = now;
      __lastMoveDir = dir;
    }
  }

  function move(dx){
    const gw=stage.clientWidth, pw=player.clientWidth;
    const pr=player.getBoundingClientRect(), gr=stage.getBoundingClientRect();
    let x=(pr.left-gr.left)+dx;
    x=Math.max(6,Math.min(gw-pw-6,x));
    player.style.left=(x+pw/2)+'px';

    player.classList.add('walking');
    setTimeout(()=> player.classList.remove('walking'), 300);
    playPlayerStep();
    announceMove(dx);
  }

  // —— 強力封鎖 contenteditable 的輸入 —— //
  stage.addEventListener('beforeinput', e => { e.preventDefault(); }, true);
  stage.addEventListener('input', e => {
    e.preventDefault();
    if (stage.childNodes.length > 0) {
      [...stage.childNodes].forEach(n=>{ if (n.nodeType === Node.TEXT_NODE) n.remove(); });
    }
  });

  function isTypingTarget(el){
    if (!el) return false;
    const tag = el.tagName;
    if (tag === 'INPUT' || tag === 'TEXTAREA') return true;
    if (el.isContentEditable && el !== stage) return true;
    return false;
  }

  function isKickKey(e){
    return e.code === 'Space' || e.code === 'Enter' || e.code === 'NumpadEnter' ||
           e.code === 'KeyZ'  || e.key  === 'z'    || e.key  === 'Z';
  }

  // —— 全域攔鍵（只在 S.running 時作用）——
  window.addEventListener('keydown', (e)=>{
    if (!S.running) return;
    if (isTypingTarget(e.target)) return;

    if (e.code === 'ArrowLeft') {
      move(-24); e.preventDefault();
    } else if (e.code === 'ArrowRight') {
      move(24); e.preventDefault();
    } else if (isKickKey(e)) {
      e.preventDefault();
      requestAnimationFrame(()=> doKick());
    }
  });
})();
</script>
<!-- footer -->
<footer role="contentinfo" class="footer" tabindex="0">
  <p>© 2025 開發者：Lîm A-kâu（林阿猴） & Kim Chio（金蕉）。</p>
</footer>
</body>
</html>
